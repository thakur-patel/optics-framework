<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optics API Tester</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #f7f7f7 60%, #e3eafc 100%);
      margin: 0;
      min-height: 100vh;
    }

    .container {
      max-width: 1100px;
      margin: 2em auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px #b3c2e0;
      padding: 2.5em 2em 2em 2em;
      display: flex;
      flex-direction: column;
      gap: 2em;
    }

    h1 {
      text-align: center;
      font-size: 2.3em;
      font-weight: 700;
      letter-spacing: 1px;
      color: #2a3a5e;
      margin-bottom: 0.5em;
    }

    .row {
      display: flex;
      gap: 2em;
      flex-wrap: wrap;
    }

    .column {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 1.5em;
    }

    .card {
      background: #f8fbff;
      border-radius: 12px;
      box-shadow: 0 2px 8px #e3eafc;
      padding: 1.5em 1.2em;
      margin-bottom: 0.5em;
    }

    .form-group {
      margin-bottom: 1em;
    }

    label {
      display: block;
      margin-bottom: 0.3em;
      font-weight: 600;
      color: #2a3a5e;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 0.6em;
      border-radius: 6px;
      border: 1px solid #b3c2e0;
      font-size: 1em;
      background: #f7faff;
      transition: border 0.2s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border: 1.5px solid #007bff;
      outline: none;
    }

    button {
      padding: 0.6em 1.5em;
      border: none;
      border-radius: 6px;
      background: linear-gradient(90deg, #007bff 60%, #4f8cff 100%);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      margin-top: 0.5em;
      box-shadow: 0 2px 8px #e3eafc;
      transition: background 0.2s;
    }

    button:disabled {
      background: #b3c2e0;
      color: #fff;
      cursor: not-allowed;
    }

    .button-group {
      display: flex;
      gap: 0.7em;
      flex-wrap: wrap;
    }

    .response {
      background: #f0f4fa;
      border-radius: 8px;
      padding: 1.2em;
      margin-top: 1em;
      font-size: 1em;
      white-space: pre-wrap;
      color: #2a3a5e;
      box-shadow: 0 2px 8px #e3eafc;
      min-height: 120px;
      max-height: 320px;
      overflow-y: auto;
    }

    .img-preview {
      max-width: 100%;
      max-height: 340px;
      border-radius: 10px;
      border: 1.5px solid #b3c2e0;
      margin-top: 1em;
      box-shadow: 0 2px 8px #e3eafc;
      object-fit: contain;
      background: #fff;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    @media (max-width: 900px) {
      .container {
        padding: 1em;
      }

      .row {
        flex-direction: column;
        gap: 1em;
      }

      .column {
        min-width: 0;
      }
    }

    .section-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #2a3a5e;
      margin-bottom: 0.7em;
    }

    .session-id {
      font-size: 0.95em;
      color: #007bff;
      font-weight: 600;
      background: #e3eafc;
      border-radius: 6px;
      padding: 0.3em 0.7em;
      margin-bottom: 0.5em;
      display: inline-block;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      padding: 0.8em;
      background: #f8fbff;
      border-radius: 8px;
      border: 1px solid #e3eafc;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5em;
      cursor: pointer;
      font-weight: 500;
      color: #2a3a5e;
      user-select: none;
    }

    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
      accent-color: #007bff;
    }

    .checkbox-label span {
      font-size: 0.95em;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Optics API Tester</h1>
    <div class="row">
      <div class="column">
        <div class="card">
          <div class="section-title">Session Controls</div>
          <form id="session-form">
            <div class="form-group">
              <label for="driver_list">Driver Sources</label>
              <div id="driver_list"></div>
              <div style="margin-top:0.6em;"><button type="button" onclick="addDriverEntry()">Add driver</button></div>
            </div>
            <div class="form-group">
              <label for="elements_list">Elements Sources</label>
              <div id="elements_list"></div>
              <div style="margin-top:0.6em;"><button type="button" onclick="addElementEntry()">Add element
                  source</button></div>
            </div>
            <div class="form-group">
              <label for="text_list">Text Detection Sources</label>
              <div id="text_list"></div>
              <div style="margin-top:0.6em;"><button type="button" onclick="addTextEntry()">Add text detection</button>
              </div>
            </div>
            <div class="form-group">
              <label for="image_list">Image Detection Sources</label>
              <div id="image_list"></div>
              <div style="margin-top:0.6em;"><button type="button" onclick="addImageEntry()">Add image
                  detection</button></div>
            </div>
            <!-- Per-source configs are now managed below -->
            <div class="button-group">
              <button type="button" onclick="startSession()">Start Session</button>
              <button type="button" onclick="stopSession()">Stop Session</button>
            </div>
          </form>
          <div class="form-group">
            <label for="session_id">Session ID</label>
            <span class="session-id"><input type="text" id="session_id" readonly
                style="border:none;background:transparent;width:80%;color:#007bff;font-weight:600;"></span>
          </div>
        </div>
      </div>
      <div class="column">
        <div class="card">
          <div class="section-title">API Actions</div>
          <form id="keyword-form">
            <div class="form-group">
              <label for="keyword">Keyword</label>
              <input type="text" id="keyword" value="capture_screenshot">
            </div>
            <div class="form-group">
              <label for="params">Params (comma separated)</label>
              <input type="text" id="params" value="">
            </div>
            <div class="button-group">
              <button type="button" onclick="executeKeyword()">Execute Keyword</button>
            </div>
          </form>
          <div class="form-group">
            <label>Element Filters</label>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="filter_all" value="all" onchange="handleAllFilter()">
                <span>All</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter_interactive" value="interactive">
                <span>Interactive</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter_buttons" value="buttons">
                <span>Buttons</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter_inputs" value="inputs">
                <span>Inputs</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter_images" value="images">
                <span>Images</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter_text" value="text">
                <span>Text</span>
              </label>
            </div>
          </div>
          <div class="button-group">
            <button type="button" onclick="getScreenshot()">Get Screenshot</button>
            <button type="button" onclick="getElements()">Get Elements</button>
            <button type="button" onclick="getPageSource()">Get Page Source</button>
            <button type="button" onclick="getScreenElements()">Get Screen Elements</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Screenshot Preview</div>
          <img id="screenshot-img" class="img-preview" src="" alt="Screenshot will appear here">
        </div>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <div class="card">
          <div class="section-title">Response</div>
          <div id="response" class="response"></div>
        </div>
      </div>

    </div>
  </div>
  <script>
    let sessionId = '';
    let previousSessionId = '';
    function showResponse(data) {
      document.getElementById('response').textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }
    function logRequest(url, options) {
      console.log('API Request:', url, options);
    }
    function logResponse(url, response) {
      console.log('API Response from', url, response);
    }
    // Use the correct API base URL for all requests
    const API_BASE = 'http://localhost:8000';

    function startSession() {
      previousSessionId = sessionId;
      // Collect per-source lists from the dynamic editors
      const driver_sources = collectListEntries('driver_list');
      const elements_sources = collectListEntries('elements_list');
      const text_detection = collectListEntries('text_list');
      const image_detection = collectListEntries('image_list');
      // If user provided top-level Appium fields, convert them to the new driver_sources entry
      // to follow the server's preferred configuration format. This keeps backwards compatibility
      // while warning users about the deprecation.
      const url = `${API_BASE}/v1/sessions/start`;
      const payload = {driver_sources, elements_sources, text_detection, image_detection};

      const options = {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)};
      logRequest(url, options);
      fetch(url, options)
        .then(res => res.json())
        .then(data => {
          logResponse(url, data);
          if (data.session_id) {
            sessionId = data.session_id;
            document.getElementById('session_id').value = sessionId;
          }
          showResponse(data);
        })
        .catch(err => {logResponse(url, err); showResponse(err);});
    }

    // --- Dynamic list helpers and renderers ---
    function collectListEntries(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return [];
      const entries = [];
      Array.from(container.querySelectorAll('.list-entry')).forEach((el) => {
        const name = el.querySelector('.entry-name').value.trim();
        const cfgText = el.querySelector('.entry-config').value.trim();
        let cfg = null;
        if (cfgText) {
          try {
            cfg = JSON.parse(cfgText);
          } catch (e) {
            alert('Invalid JSON in config: ' + e.message);
            cfg = null;
          }
        }
        if (cfg === null || cfg === '') {
          // send legacy string form
          entries.push(name);
        } else {
          const obj = {};
          obj[name] = cfg === null ? null : cfg;
          entries.push(obj);
        }
      });
      return entries;
    }

    function addDriverEntry(name = 'appium', config = {enabled: true, url: 'http://localhost:4723', capabilities: {appActivity: 'com.android.contacts.activities.PeopleActivity', appPackage: 'com.google.android.contacts', automationName: 'UiAutomator2', deviceName: 'emulator-5554', platformName: 'Android'}}) {
      addListEntry('driver_list', name, JSON.stringify(config, null, 2));
    }

    function addElementEntry(name = 'appium_find_element', config = {enabled: true}) {
      addListEntry('elements_list', name, JSON.stringify(config, null, 2));
    }

    function addTextEntry(name = 'easyocr', config = {enabled: false}) {
      addListEntry('text_list', name, JSON.stringify(config, null, 2));
    }

    function addImageEntry(name = 'templatematch', config = {enabled: false}) {
      addListEntry('image_list', name, JSON.stringify(config, null, 2));
    }

    function addListEntry(containerId, name, configText) {
      const container = document.getElementById(containerId);
      const wrapper = document.createElement('div');
      wrapper.className = 'list-entry';
      wrapper.style.border = '1px solid #e3eafc';
      wrapper.style.padding = '0.6em';
      wrapper.style.marginBottom = '0.6em';
      wrapper.innerHTML = `
        <div style="display:flex;gap:0.6em;align-items:center;margin-bottom:0.4em;">
          <input class="entry-name" style="flex:0 0 180px;" value="${name}">
          <button type="button" onclick="this.parentNode.parentNode.remove()">Remove</button>
        </div>
        <textarea class="entry-config" rows="4" style="width:100%;font-family:monospace;">${configText || ''}</textarea>
      `;
      container.appendChild(wrapper);
    }

    // Initialize with sample entries similar to samples/contact/config.yaml
    document.addEventListener('DOMContentLoaded', () => {
      // drivers
      addDriverEntry();
      // elements
      addElementEntry('appium_find_element', {enabled: true});
      addElementEntry('appium_screenshot', {enabled: true});
      // text & image
      addTextEntry();
      addImageEntry();
      // Setup filter checkbox handlers
      setupFilterCheckboxes();
    });
    function stopSession() {
      if (!sessionId) {showResponse('No session started'); return;}
      const url = `${API_BASE}/v1/sessions/${sessionId}/stop`;
      const options = {method: 'DELETE'};
      logRequest(url, options);
      fetch(url, options)
        .then(res => res.json())
        .then(data => {
          logResponse(url, data);
          showResponse(data);
          previousSessionId = sessionId;
          sessionId = '';
          document.getElementById('session_id').value = '';
          document.getElementById('screenshot-img').src = '';
        })
        .catch(err => {logResponse(url, err); showResponse(err);});
    }
    function executeKeyword() {
      if (!sessionId) {showResponse('No session started'); return;}
      const keyword = document.getElementById('keyword').value;
      const params = document.getElementById('params').value.split(',').map(s => s.trim()).filter(Boolean);
      const url = `${API_BASE}/v1/sessions/${sessionId}/action`;
      const options = {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({mode: 'keyword', keyword, params})
      };
      logRequest(url, options);
      // Execute keyword first, then after a short delay fetch screenshot and elements concurrently
      fetch(url, options)
        .then(res => res.json())
        .then(data => {
          logResponse(url, data);
          showResponse(data);
        })
        .catch(err => {logResponse(url, err); showResponse(err);})
        .finally(() => {
          // wait briefly for the action to take effect on device
          setTimeout(() => {
            Promise.all([
              // both functions now return the fetch promise
              getScreenshot(),
              getElements(),
            ])
              .then(() => {
                // both updated UI independently; append info to response
                showResponse({info: 'Screenshot and Elements refreshed'});
              })
              .catch((e) => {
                console.warn('Error fetching screenshot/elements', e);
              });
          }, 2000);
        });
    }
    function getScreenshot() {
      if (!sessionId) {showResponse('No session started'); return;}
      const url = `${API_BASE}/v1/sessions/${sessionId}/screenshot`;
      logRequest(url, {});
      return fetch(url)
        .then((res) => res.json())
        .then((data) => {
          logResponse(url, data);
          // Prevent base64 from overflowing response area
          let displayData = JSON.parse(JSON.stringify(data));
          if (displayData.data && displayData.data.result) {
            // If result is a long base64 string, truncate for display
            if (typeof displayData.data.result === 'string' && displayData.data.result.length > 100) {
              displayData.data.result = displayData.data.result.substring(0, 100) + '... [truncated]';
            }
            // If result is an object with screenshot, truncate screenshot
            if (displayData.data.result.screenshot && displayData.data.result.screenshot.length > 100) {
              displayData.data.result.screenshot = displayData.data.result.screenshot.substring(0, 100) + '... [truncated]';
            }
          }
          showResponse(displayData);
          // Handle both legacy and new API formats
          let base64 = '';
          if (data.data && typeof data.data.result === 'string') {
            // New API: result is base64 string
            base64 = data.data.result;
          } else if (data.data && data.data.result && data.data.result.screenshot) {
            // Legacy: result.screenshot is base64 string
            base64 = data.data.result.screenshot;
          }
          if (base64) {
            document.getElementById('screenshot-img').src = 'data:image/png;base64,' + base64;
          } else {
            document.getElementById('screenshot-img').src = '';
          }
          return data;
        })
        .catch((err) => {
          logResponse(url, err);
          showResponse(err);
          throw err;
        });
    }
    function getSelectedFilters() {
      const filters = [];
      const checkboxes = ['filter_all', 'filter_interactive', 'filter_buttons', 'filter_inputs', 'filter_images', 'filter_text'];
      checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox && checkbox.checked && id !== 'filter_all') {
          filters.push(checkbox.value);
        }
      });
      // If "all" is checked or no filters selected, return empty array (default behavior)
      const allChecked = document.getElementById('filter_all').checked;
      return allChecked || filters.length === 0 ? null : filters;
    }

    function handleAllFilter() {
      const allCheckbox = document.getElementById('filter_all');
      if (allCheckbox.checked) {
        // Uncheck all other filters when "all" is selected
        ['filter_interactive', 'filter_buttons', 'filter_inputs', 'filter_images', 'filter_text'].forEach(id => {
          document.getElementById(id).checked = false;
        });
      }
    }

    // Uncheck "all" when any specific filter is selected
    function setupFilterCheckboxes() {
      ['filter_interactive', 'filter_buttons', 'filter_inputs', 'filter_images', 'filter_text'].forEach(id => {
        document.getElementById(id).addEventListener('change', function() {
          if (this.checked) {
            document.getElementById('filter_all').checked = false;
          }
        });
      });
    }

    function getElements() {
      if (!sessionId) {showResponse('No session started'); return;}
      const filterConfig = getSelectedFilters();
      let url = `${API_BASE}/v1/sessions/${sessionId}/elements`;

      // Build query parameters if filters are selected
      if (filterConfig && filterConfig.length > 0) {
        const params = new URLSearchParams();
        filterConfig.forEach(filter => {
          params.append('filter_config', filter);
        });
        url += '?' + params.toString();
      }

      logRequest(url, {});
      return fetch(url)
        .then((res) => res.json())
        .then((data) => {
          logResponse(url, data);
          showResponse(data);
          return data;
        })
        .catch((err) => {
          logResponse(url, err);
          showResponse(err);
          throw err;
        });
    }
    function getPageSource() {
      if (!sessionId) {showResponse('No session started'); return;}
      const url = `${API_BASE}/v1/sessions/${sessionId}/source`;
      logRequest(url, {});
      fetch(url)
        .then(res => res.json())
        .then(data => {logResponse(url, data); showResponse(data);})
        .catch(err => {logResponse(url, err); showResponse(err);});
    }
    function getScreenElements() {
      if (!sessionId) {showResponse('No session started'); return;}
      const url = `${API_BASE}/v1/sessions/${sessionId}/screen_elements`;
      logRequest(url, {});
      fetch(url)
        .then(res => res.json())
        .then(data => {logResponse(url, data); showResponse(data);})
        .catch(err => {logResponse(url, err); showResponse(err);});
    }
  </script>
</body>

</html>
